Ugly ass code. Feel free to improve it / make it more readable.
